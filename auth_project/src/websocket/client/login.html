<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="referrer" content="no-referrer">
  <title>Đăng nhập & Đăng ký</title>
  <style>
      :root {
          --primary-color: #6b48ff;
          --secondary-color: #00ddeb;
          --text-color: #333;
          --transition: all 0.5s ease;
          --shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
      }

      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
          font-family: 'Poppins', sans-serif;
      }

      body {
          display: flex;
          justify-content: center;
          align-items: center;
          min-height: 100vh;
          background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
      }

      .container {
          position: relative;
          width: min(800px, 90vw);
          height: 500px;
          background: #fff;
          box-shadow: var(--shadow);
          border-radius: 20px;
          overflow: hidden;
      }

      .user {
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: flex;
      }

      .form-box {
          width: 50%;
          height: 100%;
          background: #fff;
          padding: 40px;
          display: flex;
          flex-direction: column;
          justify-content: center;
          transition: var(--transition);
      }

      .form-box h2 {
          font-size: 2rem;
          color: var(--text-color);
          margin-bottom: 20px;
          text-align: center;
      }

      .input-box {
          position: relative;
          margin-bottom: 35px;
      }

      .input-box input {
          width: 100%;
          padding: 10px 0;
          font-size: 1rem;
          color: var(--text-color);
          border: none;
          border-bottom: 2px solid var(--text-color);
          outline: none;
          background: transparent;
          transition: var(--transition);
      }

      .input-box label {
          position: absolute;
          top: 10px;
          left: 0;
          font-size: 1rem;
          color: var(--text-color);
          pointer-events: none;
          transition: var(--transition);
      }

      .input-box input:focus ~ label,
      .input-box input:valid ~ label {
          top: -20px;
          font-size: 0.75rem;
          color: var(--primary-color);
      }

      .input-box input:focus {
          border-bottom: 2px solid var(--primary-color);
      }

      .error {
          color: #ff4444;
          font-size: 0.8rem;
          margin-top: 5px;
          display: none;
      }

      button {
          padding: 10px 20px;
          font-size: 1rem;
          text-transform: uppercase;
          letter-spacing: 2px;
          background: var(--primary-color);
          color: #fff;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          transition: var(--transition);
      }

      button:hover {
          background: var(--secondary-color);
      }

      .signup {
          left: 50%;
      }

      .signin {
          left: 0;
      }

      .panel {
          width: 50%;
          height: 100%;
          background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
          color: #fff;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          padding: 40px;
          transition: var(--transition);
      }

      .panel h3 {
          font-size: 1.5rem;
          margin-bottom: 20px;
      }

      .panel p {
          font-size: 1rem;
          margin-bottom: 20px;
      }

      .panel button {
          background: transparent;
          border: 2px solid #fff;
      }

      .panel button:hover {
          background: #fff;
          color: var(--primary-color);
      }

      .signup-panel {
          left: 0;
      }

      .signin-panel {
          right: 0;
      }

      .container.sign-up-mode .signin {
          left: -100%;
      }

      .container.sign-up-mode .signup {
          left: 0;
      }

      .container.sign-up-mode .signup-panel {
          left: 50%;
      }

      .container.sign-up-mode .signin-panel {
          right: -100%;
      }

      @media (max-width: 870px) {
          .container {
              width: 100%;
              height: 100vh;
              border-radius: 0;
          }

          .form-box {
              width: 100%;
              padding: 20px;
          }

          .panel {
              display: none;
          }

          .signup {
              left: 100%;
          }

          .signin {
              left: 0;
          }

          .container.sign-up-mode .signin {
              left: -100%;
          }

          .container.sign-up-mode .signup {
              left: 0;
          }
      }
  </style>
</head>
<body>
<div class="container">
  <div class="user signin">
    <div class="form-box signin">
      <h2>Đăng nhập</h2>
      <form id="login-form">
        <div class="input-box">
          <input id="login-username" type="text" required>
          <label>Tên đăng nhập</label>
          <div class="error" id="login-username-error">Vui lòng nhập tên đăng nhập</div>
        </div>
        <div class="input-box">
          <input id="login-password" type="password" required>
          <label>Mật khẩu</label>
          <div class="error" id="login-password-error">Mật khẩu phải có ít nhất 6 ký tự</div>
        </div>
        <div class="error" id="login-error"></div>
        <button type="submit">Đăng nhập</button>
      </form>
    </div>
    <div class="panel signin-panel">
      <h3>Chào mừng trở lại!</h3>
      <p>Đã có tài khoản? Đăng nhập ngay!</p>
      <button id="sign-in-btn">Đăng nhập</button>
    </div>
  </div>
  <div class="user signup">
    <div class="panel signup-panel">
      <h3>Chào bạn mới!</h3>
      <p>Bạn chưa có tài khoản? Đăng ký ngay để trải nghiệm!</p>
      <button id="sign-up-btn">Đăng ký</button>
    </div>
    <div class="form-box signup">
      <h2>Đăng ký</h2>
      <form id="register-form">
        <div class="input-box">
          <input id="register-username" type="text" required>
          <label>Tên đăng nhập</label>
          <div class="error" id="register-username-error">Tên đăng nhập phải từ 3-20 ký tự</div>
        </div>
<!--        <div class="input-box">-->
<!--          <input id="register-email" type="email" required>-->
<!--          <label>Email</label>-->
<!--          <div class="error" id="register-email-error">Vui lòng nhập email hợp lệ</div>-->
<!--        </div>-->
        <div class="input-box">
          <input id="register-password" type="password" required>
          <label>Mật khẩu</label>
          <div class="error" id="register-password-error">Mật khẩu phải có ít nhất 6 ký tự</div>
        </div>
        <div class="input-box">
          <input id="register-repassword" type="password" required>
          <label>Nhập lại mật khẩu</label>
          <div class="error" id="register-repassword-error">Mật khẩu phải có ít nhất 6 ký tự</div>
        </div>

        <div class="error" id="register-error"></div>
        <button type="submit">Đăng ký</button>
      </form>
    </div>
  </div>
</div>

<script>
  // Form validation
  function validateLogin(username, password) {
    const usernameError = document.getElementById('login-username-error');
    const passwordError = document.getElementById('login-password-error');
    let isValid = true;

    usernameError.style.display = 'none';
    passwordError.style.display = 'none';

    if (!username) {
      usernameError.style.display = 'block';
      isValid = false;
    }
    if (password.length < 6) {
      passwordError.style.display = 'block';
      isValid = false;
    }
    return isValid;
  }

  function validateRegister(username, password,repassword) {
    const usernameError = document.getElementById('register-username-error');
    // const emailError = document.getElementById('register-email-error');
    const passwordError = document.getElementById('register-password-error');
    const repasswordError = document.getElementById('register-repassword-error');
    // const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    let isValid = true;

    usernameError.style.display = 'none';
    // emailError.style.display = 'none';
    passwordError.style.display = 'none';
    repasswordError.style.display = 'none';

    if (username.length < 3 || username.length > 20) {
      usernameError.style.display = 'block';
      isValid = false;
    }
    // if (!emailRegex.test(email)) {
    //   emailError.style.display = 'block';
    //   isValid = false;
    // }
    if (password.length < 6) {
      passwordError.style.display = 'block';
      isValid = false;
    }
    if (repassword.length < 6) {
      repasswordError.style.display = 'block';
      isValid = false;
    }

    return isValid;
  }

  document.getElementById('login-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    const loginError = document.getElementById('login-error');

    loginError.innerText = '';

    if (!validateLogin(username, password)) return;

    try {
      const response = await fetch('http://localhost:3000/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password }),
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.message || 'Đăng nhập thất bại!');
      }
      if (data.access_token) {
        localStorage.setItem('access_token', data.access_token);
        window.location.href = 'chat.html';
      } else {
        loginError.innerText = data.message || 'Đăng nhập thất bại!';
      }
    } catch (error) {
      loginError.innerText = 'Lỗi kết nối server!';
    }
  });

  document.getElementById('register-form').addEventListener('submit', async (event) => {
    event.preventDefault();
    const username = document.getElementById('register-username').value;
    // const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const repassword = document.getElementById('register-repassword').value;
    const registerError = document.getElementById('register-error');

    registerError.innerText = '';

    if (!validateRegister(username, password,repassword) )return;

    try {
      const response = await fetch('http://localhost:3000/auth/sign-up', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password,repassword }),
      });

      const data = await response.json();
      if (!response.ok) {
        throw new Error(data.message || 'Đăng nhập thất bại!');
      }
      if (data.access_token) {
        localStorage.setItem('access_token', data.access_token);
        window.location.href = 'chat.html';
      }
      if (data.create) {
        alert('Đăng ký thành công! Vui lòng đăng nhập.');
        document.querySelector('.container').classList.remove('sign-up-mode');
      } else {
        registerError.innerText = data.message || 'Đăng ký thất bại!';
      }
    } catch (error) {
      registerError.innerText = 'Lỗi kết nối server!';
    }
  });

  document.getElementById('sign-up-btn').addEventListener('click', () => {
    document.querySelector('.container').classList.add('sign-up-mode');
  });

  document.getElementById('sign-in-btn').addEventListener('click', () => {
    document.querySelector('.container').classList.remove('sign-up-mode');
  });
</script>
</body>
</html>